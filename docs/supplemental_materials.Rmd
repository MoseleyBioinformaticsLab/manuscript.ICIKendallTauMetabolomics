---
title: 'Supplemental Materials'
author: 'Robert M Flight, Praneeth S Bhatt, and Hunter NB Moseley'
date: '`r Sys.time()`'
output: 
  rmarkdown::word_document:
    keep_md: true
  rmarkdown::html_document:
    self_contained: yes
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
bibliography: '`r here::here("docs/icikt_manuscript.json")`'
csl: '`r here::here("docs/plos-computational-biology.csl")`'
editor_options: 
  chunk_output_type: console
---

```{r}
#| label: setup1
#| include: false
targets::tar_source(files = c("./packages.R", "R"))
supp_figure_count = dn_counter$new("Figure ", "_", "S")
supp_table_count = dn_counter$new("Table ", "_", "S")
```

```{r}
#| label: setup2
#| include: false
doc_type = knitr::opts_knit$get("rmarkdown.pandoc.to")
if (doc_type %in% "docx") {
  unlink(here::here("docs", "supplemental_materials_files"), recursive = TRUE)
}

knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.width = 8,
  fig.height = 6,
  fig.keep = "all",
  fig.process = supp_figure_count$modify_path,
  tab.cap.style = "paragraph",
  tab.cap.pre = "",
  tab.cap.sep = "",
  dpi = 600,
  dev = "ragg_png"
)

```

```{r}
#| label: load

tar_load(c(
  references,
  missingness_percentage_pvalues_plot,
  simple_kt_pearson_comparison_plot,
  all_kt,
  realistic_reference_plot,
  realistic_reference_plot_3,
  realistic_comparison_plot_3,
  censored_compare_plots,
  vl_na_perc_graph,
  performance_plot,
  limma_stats_table_supp,
  qratio_plot_all,
  qratio_stats_table_all
))
```

```{r}
#| label: increment
supp_figure_count$increment(c(
  "left-censorship-missingness-pvalues",
  "kt_pearson",
  "ici_distribution",
  "kt_distribution",
  "realistic_reference",
  "realistic_comparison_outliers",
  "realistic_reference_outliers",
  "leftcensored",
  "na-perc-lod",
  "qratio-plot-all",
  "performance"
))

supp_table_count$increment(c(
  "limma-stats-table-supp",
  "qratio-stats-table-all"
))
```

## Left Censoring as a Cause for Missingness


```{r}
#| label: left-censorship-missingness-pvalues
#| fig.width: 10
#| fig.height: 8
missingness_percentage_pvalues_plot
```

`r supp_figure_count$label_text("left-censorship-missingness-pvalues")`.
Percent missing values in each dataset compared to the p-values from the left censored binomial test.



## Simulated Data

### Simple Data Set


```{r}
#| label: kt_pearson
simple_kt_pearson_comparison_plot
```

`r supp_figure_count$label_text("kt_pearson")`. Comparison of ICI-Kt and Pearson correlations for perfectly positive and negatively correlated samples, systematically replacing values with NA.
NA values from Pearson were replaced with zero for this comparison.

We can also examine the full set of positive and negative correlations generated as we vary the number of missing entries between two positively correlated samples and two negatively correlated samples.
These distributions are shown in `r supp_figure_count$label_text("kt_distribution")`.
We can see that the distributions from both ICI-Kt and Kendall-tau are the same, which is expected given we replaced missing values (NA) with zero *within* the ICI-Kt code, and replaced missing values (NA) with zero prior to calculating Kendall-tau correlations.

```{r}
#| label: ici_distribution
ici_plot = ggplot(all_kt, aes(x = ici_kt)) +
  geom_histogram(bins = 100) +
  facet_wrap(~comp, ncol = 1) +
  labs(x = "ICI-Kt Correlation", y = "count")
ici_plot
```

`r supp_figure_count$label_text("ici_distribution")`.
ICI-Kendall-tau correlation as missing values are varied between two samples.

```{r}
#| label: kt_distribution
kt_plot = ggplot(all_kt, aes(x = kendall)) +
  geom_histogram(bins = 100) +
  facet_wrap(~comp, ncol = 1) +
  labs(x = "Kendall-tau Correlation", y = "count")
kt_plot
```

`r supp_figure_count$label_text("kt_distribution")`.
Kendall-tau correlation as missing values are varied between two samples and replaced with 0 before calculating Kendall-tau.

### Comparison to Other Correlation Measures

```{r}
#| label: realistic_reference
#| dn_id: supp_figure_count
#| fig-width: 12
#| fig-height: 8
ref_tmp_pos = realistic_reference_plot$positive +
  theme(
    axis.text = element_text(size = 10),
    strip.background = element_rect(fill = "white", color = "white"),
    panel.border = element_blank()
  )
ref_tmp_neg = realistic_reference_plot$negative +
  theme(
    axis.text = element_text(size = 10),
    strip.background = element_rect(fill = "white", color = "white"),
    panel.border = element_blank()
  )
reference_plot = ref_tmp_pos + ref_tmp_neg
reference_plot
```

`r supp_figure_count$label_text("realistic_reference")`.
Difference of estimated correlation with missingness introduced compared to a reference correlation of 1 for the positive or -1 for the negative case, as a function of the average number of missing entries in X and Y sample (# NA).
Points are colored by how many points are missing on average between the two samples X and Y.

```{r}
#| label: realistic_comparison_outliers
#| fig-width: 8
#| fig-height: 8
comp_tmp_pos_3 = purrr::map(realistic_comparison_plot_3$positive, \(x) {
  x + theme(axis.text = element_text(size = 10))
})
comp_tmp_neg_3 = purrr::map(realistic_comparison_plot_3$negative, \(x) {
  x + theme(axis.text = element_text(size = 10))
})
comparison_plot_3 = wrap_plots(
  c(comp_tmp_pos_3, comp_tmp_neg_3),
  nrow = 2,
  byrow = FALSE
)
comparison_plot_3
```

`r supp_figure_count$label_text("realistic_comparison_outliers")`. 
More variance was introduced at one end of the log-normal distribution in one sample to create a small percentage of outlier points compared to the other samples compared.
This figure is comparing the correlation values obtained by Pearson, Kendall, and ICI-Kt correlation as an increasing number of missing values (0 - 500) in the bottom half of either sample for both positively (correlation = 1) and negatively (correlation = -1) correlated samples.
Points are colored by how many points were set to missing on average between the two samples.
A subset of `r format(realistic_comparison_plot_3$n_subset, big.mark = ",", big.interval = 3L)` points was used for visualization.

```{r}
#| label: realistic_reference_outliers
#| dn_id: supp_figure_count
#| fig-width: 12
#| fig-height: 8
ref_tmp_pos_3 = realistic_reference_plot_3$positive +
  theme(
    axis.text = element_text(size = 10),
    strip.background = element_rect(fill = "white", color = "white"),
    panel.border = element_blank()
  )
ref_tmp_neg_3 = realistic_reference_plot_3$negative +
  theme(
    axis.text = element_text(size = 10),
    strip.background = element_rect(fill = "white", color = "white"),
    panel.border = element_blank()
  )
reference_plot_3 = ref_tmp_pos_3 + ref_tmp_neg_3
reference_plot_3
```

`r supp_figure_count$label_text("realistic_reference_outliers")`.
More variance was introduced at one end of the log-normal distribution in one sample to create a small percentage of outlier points compared to the other samples compared.
This figure is showing the difference of estimated correlation with missingness introduced compared to a reference correlation of 1 for the positive or -1 for the negative case, as a function of the average number of missing entries in X and Y sample (# NA).
Points are colored by how many points are missing on average between the two samples X and Y.

### Semi-Realistic Data Set

```{r}
#| label: leftcensored
#| fig-height: 8
#| fig.width: 9
left_plot = purrr::map(censored_compare_plots$left, \(x) {
  x + theme(axis.text = element_text(size = 8))
}) |>
  wrap_plots(ncol = 1)
log_plot = purrr::map(censored_compare_plots$log, \(x) {
  x + theme(axis.text = element_text(size = 8))
}) |>
  wrap_plots(ncol = 1)
random_plot = purrr::map(censored_compare_plots$random, \(x) {
  x + theme(axis.text = element_text(size = 8))
}) |>
  wrap_plots(ncol = 1)

(left_plot | log_plot | random_plot)
```

`r supp_figure_count$label_text("leftcensored")`.
Effect of introducing missing values from a cutoff (A & B) or randomly (C) on different measures of correlation, including ICI-Kt, Kendall with pairwise complete, Kendall replacing missing with 0, Pearson with pairwise complete, and Pearson replacing missing with 0. 
A) Missing values introduced by setting an increasing cutoff. 
B) Missing values introduced by setting an increasing cutoff, and then log-transforming the values before calculating correlation. 
C) Missing values introduced at random. For the random case, each sample of random positions was repeated 100 times.

## Changes In Correlation Due to Changes in Dynamic Range and Imputation


```{r}
#| label: na-perc-lod
vl_na_perc_graph
```

`r supp_figure_count$label_text("na-perc-lod")`.
Number of missing values in each of the 100 samples as a function of changing the dynamic range of the values in the sample by increasing the lower limit of detection.

## Outlier Detection

`r supp_table_count$label_text("limma-stats-table-supp")`.
The statistical results of the pairwise comparisons of each method based on the significant fractions after removing outliers.
P-values were adjusted using the Bonferroni method.

```{r}
#| label: limma_stats_table_supp
limma_stats_table_supp
```

## Feature-Feature Network Partitioning

```{r}
#| label: qratio-plot-all
#| fig-height: 12
qratio_plot_all
```

`r supp_figure_count$label_text("qratio-plot-all")`.
Boxplot and sina plots of paired differences of partitioning ratios across datasets.
Red line indicates zero difference.
Differences are calculated as $method_{1} - method_{2}$.

`r supp_table_count$label_text("qratio-stats-table-all")`.
Paired t-test statistics comparing all the methods to each other. P-values were adjusted using the Bonferroni adjustment.

```{r}
#| label: qratio-stats-table-all
qratio_stats_table_all
```

## Performance


```{r}
#| label: performance
performance_plot
```

`r supp_figure_count$label_text("performance")`. 
Time in seconds needed as a function of the number of features, with a fitted line for the assumed complexity for each of the methods tested, including R's Pearson correlation, the ICI-Kt mergesort, and R's Kendall-tau correlation algorithm.


```{r}
#| label: save-supp-figures-tables
saveRDS(supp_figure_count, file = here::here("docs/supp_figure_count.rds"))
saveRDS(supp_table_count, file = here::here("docs/supp_table_count.rds"))
```

## References
